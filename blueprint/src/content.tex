% In this file you should put the actual content of the blueprint.
% It will be used both by the web and the print version.
% It should *not* include the \begin{document}
%
% If you want to split the blueprint content into several files then
% the current file can be a simple sequence of \input. Otherwise It
% can start with a \section or \chapter for instance.

\chapter{The Forward Euler Method}

We implement the explicit Euler method for ODEs and prove its convergence.
Consider the initial value problem $y'(t) = v(t, y(t))$, $y(t_0) = y_0$, where
$v \colon \mathbb{R} \times E \to E$ is a vector field on a normed space $E$.

\section{Grid helpers}

\begin{lemma}[Floor on grid interval]
  \label{lem:floor_eq_of_mem_Ico}
  \lean{Nat.floor_div_eq_of_mem_Ico}
  \leanok
  If $t \in [a + nh, a + (n+1)h)$ and $h > 0$, then
  $\lfloor (t - a)/h \rfloor = n$.
\end{lemma}

\begin{lemma}[Membership in floor interval]
  \label{lem:mem_Ico_floor}
  \lean{mem_Ico_Nat_floor_div}
  \leanok
  If $h > 0$ and $t \geq a$, then
  $t \in [a + \lfloor (t-a)/h \rfloor \cdot h,\; a + (\lfloor (t-a)/h \rfloor + 1) \cdot h)$.
\end{lemma}

\begin{theorem}[Local finiteness of regular grid]
  \label{thm:locallyFinite_Icc_grid}
  \lean{locallyFinite_Icc_grid}
  \leanok
  \uses{lem:floor_eq_of_mem_Ico, lem:mem_Ico_floor}
  The family of closed intervals $\{[a + nh, a + (n+1)h]\}_{n \in \mathbb{N}}$
  is locally finite.
\end{theorem}

\begin{theorem}[Continuity from grid cells]
  \label{thm:continuousOn_Ici_of_Icc_grid}
  \lean{ContinuousOn.of_Icc_grid}
  \leanok
  \uses{thm:locallyFinite_Icc_grid, lem:mem_Ico_floor}
  If $f$ is continuous on each cell $[a + nh, a + (n+1)h]$, then $f$ is
  continuous on $[a, \infty)$.
\end{theorem}

\section{Piecewise linear interpolation}

\begin{definition}[Piecewise linear interpolation]
  \label{def:piecewiseLinear}
  \lean{piecewiseLinear}
  \leanok
  Given a sequence of values $y$ and slopes $c$ on a regular grid with
  step size $h$ starting at $a$, the piecewise linear interpolation is
  defined for $t$ with $n = \lfloor (t-a)/h \rfloor$ by
  \[
    \mathrm{piecewiseLinear}(y, c, h, a, t) = y_n + (t - (a + nh)) \cdot c_n.
  \]
\end{definition}

\begin{definition}[Piecewise constant function]
  \label{def:piecewiseConst}
  \lean{piecewiseConst}
  \leanok
  The piecewise constant function taking value $c_n$ on
  $[a + nh, a + (n+1)h)$:
  \[
    \mathrm{piecewiseConst}(c, h, a, t) = c_{\lfloor (t-a)/h \rfloor}.
  \]
\end{definition}

\begin{theorem}[Piecewise constant on intervals]
  \label{thm:piecewiseConst_eq_on_Ico}
  \lean{piecewiseConst_eq_on_Ico}
  \leanok
  \uses{def:piecewiseConst, lem:floor_eq_of_mem_Ico}
  For $t \in [a + nh, a + (n+1)h)$,
  $\mathrm{piecewiseConst}(c, h, a, t) = c_n$.
\end{theorem}

\begin{theorem}[Grid point values]
  \label{thm:piecewiseLinear_apply_grid}
  \lean{piecewiseLinear_apply_grid}
  \leanok
  \uses{def:piecewiseLinear}
  $\mathrm{piecewiseLinear}(y, c, h, a, a + nh) = y_n$.
\end{theorem}

\begin{theorem}[Piecewise linear on intervals]
  \label{thm:piecewiseLinear_eq_on_Ico}
  \lean{piecewiseLinear_eq_on_Ico}
  \leanok
  \uses{def:piecewiseLinear, lem:floor_eq_of_mem_Ico}
  For $t \in [a + nh, a + (n+1)h)$,
  \[
    \mathrm{piecewiseLinear}(y, c, h, a, t) = y_n + (t - (a + nh)) \cdot c_n.
  \]
\end{theorem}

\begin{theorem}[Continuity of piecewise linear interpolation]
  \label{thm:piecewiseLinear_continuousOn}
  \lean{piecewiseLinear_continuousOn}
  \leanok
  \uses{def:piecewiseLinear, thm:continuousOn_Ici_of_Icc_grid, thm:piecewiseLinear_apply_grid, thm:piecewiseLinear_eq_on_Ico}
  If $y_{n+1} = y_n + h \cdot c_n$ for all $n$, then
  $\mathrm{piecewiseLinear}(y, c, h, a)$ is continuous on $[a, \infty)$.
\end{theorem}

\begin{theorem}[Right derivative of piecewise linear interpolation]
  \label{thm:piecewiseLinear_hasDerivWithinAt}
  \lean{piecewiseLinear_hasDerivWithinAt}
  \leanok
  \uses{def:piecewiseLinear, def:piecewiseConst, lem:mem_Ico_floor, thm:piecewiseLinear_eq_on_Ico}
  For $t \geq a$, the piecewise linear interpolation has right derivative
  $\mathrm{piecewiseConst}(c, h, a, t)$ at $t$.
\end{theorem}

\section{Euler method definitions}

\begin{definition}[Euler step]
  \label{def:eulerStep}
  \lean{ODE.EulerMethod.step}
  \leanok
  Given a vector field $v$, step size $h$, time $t$, and current value $y$, the
  \emph{Euler step} is
  \[
    \mathrm{step}(v, h, t, y) = y + h \cdot v(t, y).
  \]
\end{definition}

\begin{definition}[Euler points]
  \label{def:eulerPoint}
  \lean{ODE.EulerMethod.point}
  \leanok
  \uses{def:eulerStep}
  The sequence of \emph{Euler points} is defined recursively by
  \[
    y_0 = y_0, \qquad y_{n+1} = \mathrm{step}(v, h, t_0 + nh, y_n).
  \]
\end{definition}

\begin{definition}[Euler slope]
  \label{def:eulerSlope}
  \lean{ODE.EulerMethod.slope}
  \leanok
  \uses{def:eulerPoint}
  The \emph{Euler slope} on the $n$-th cell is
  $v(t_0 + nh, y_n)$.
\end{definition}

\begin{definition}[Euler path]
  \label{def:eulerPath}
  \lean{ODE.EulerMethod.path}
  \leanok
  \uses{def:eulerPoint, def:eulerSlope, def:piecewiseLinear}
  The \emph{Euler path} is the piecewise linear interpolation of the
  Euler points with Euler slopes:
  \[
    \mathrm{path} = \mathrm{piecewiseLinear}(y, c, h, t_0)
  \]
  where $y_n = \mathrm{point}(v, h, t_0, y_0, n)$ and
  $c_n = \mathrm{slope}(v, h, t_0, y_0, n)$.
\end{definition}

\begin{definition}[Euler derivative]
  \label{def:eulerDeriv}
  \lean{ODE.EulerMethod.deriv}
  \leanok
  \uses{def:eulerSlope, def:piecewiseConst}
  The \emph{Euler derivative} is the piecewise constant right derivative of
  the Euler path:
  \[
    \mathrm{deriv} = \mathrm{piecewiseConst}(\mathrm{slope}, h, t_0).
  \]
\end{definition}

\section{Error analysis}

\begin{theorem}[Global derivative bound]
  \label{thm:dist_deriv_le}
  \lean{ODE.EulerMethod.dist_deriv_le}
  \leanok
  \uses{def:eulerDeriv, def:eulerPath, def:eulerPoint, thm:piecewiseLinear_eq_on_Ico, thm:piecewiseConst_eq_on_Ico, lem:mem_Ico_floor}
  Suppose $v$ is $K$-Lipschitz in space, $L$-Lipschitz in time, and
  $\|v\| \leq M$. For all $t \geq t_0$,
  \[
    \mathrm{dist}(\mathrm{deriv}(t),\; v(t, \mathrm{path}(t)))
    \leq h(L + KM).
  \]
\end{theorem}

\begin{theorem}[Error bound]
  \label{thm:dist_path_le}
  \lean{ODE.EulerMethod.dist_path_le}
  \leanok
  \uses{thm:piecewiseLinear_continuousOn, thm:piecewiseLinear_hasDerivWithinAt, thm:dist_deriv_le}
  Let $\mathrm{sol}$ be the true solution of the ODE on $[t_0, T]$.
  Under the Lipschitz and boundedness hypotheses on $v$,
  \[
    \mathrm{dist}(\mathrm{path}(t), \mathrm{sol}(t))
    \leq \mathrm{gronwallBound}(0, K, h(L + KM), t - t_0)
  \]
  for all $t \in [t_0, T]$.
\end{theorem}

\begin{theorem}[Convergence]
  \label{thm:tendsto_path}
  \lean{ODE.EulerMethod.tendsto_path}
  \leanok
  \uses{thm:dist_path_le}
  The Euler method converges to the true solution as the step size $h \to 0^+$:
  for all $t \in [t_0, T]$,
  \[
    \mathrm{path}(v, h, t_0, y_0, t) \to \mathrm{sol}(t)
    \quad \text{as } h \to 0^+.
  \]
\end{theorem}
